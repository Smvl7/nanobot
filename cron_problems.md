# –û—Ç—á–µ—Ç –ø–æ –ø—Ä–æ–±–ª–µ–º–∞–º CronService –∏ –∏—Ö —Ä–µ—à–µ–Ω–∏—é

## üö® –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ü—Ä–æ–±–ª–µ–º—ã

### 1. –ü—Ä–æ–±–ª–µ–º–∞ "–ö–æ–º–∞" (Sleep of Death)
*   **–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–≤–∞–ª —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ –±—ã–ª –ø—É—Å—Ç –∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –∑–∞–¥–∞—á–∏ –±—ã–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–º.
*   **–ü—Ä–∏—á–∏–Ω–∞:** –°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `asyncio.sleep(–≤—Ä–µ–º—è_–¥–æ_—Å–ª–µ–¥—É—é—â–µ–π_–∑–∞–¥–∞—á–∏)`. –ï—Å–ª–∏ –∑–∞–¥–∞—á –Ω–µ—Ç ‚Äî —Å–µ—Ä–≤–∏—Å –ø—Ä–æ—Å—Ç–æ –≤—ã—Ö–æ–¥–∏–ª –∏–∑ —Ü–∏–∫–ª–∞ –∏–ª–∏ –∑–∞—Å—ã–ø–∞–ª "–Ω–∞–≤—Å–µ–≥–¥–∞".
*   **–í–ª–∏—è–Ω–∏–µ:** –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ. –ë–æ—Ç –Ω–µ –º–æ–≥ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

### 2. –ü—Ä–æ–±–ª–µ–º–∞ "–°–ª–µ–ø–æ—Ç–∞" (Cache Invalidation)
*   **–°–∏–º–ø—Ç–æ–º:** –ó–∞–¥–∞—á–∏, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ CLI (`nanobot cron add`), –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–ª–∏—Å—å –∑–∞–ø—É—â–µ–Ω–Ω—ã–º –±–æ—Ç–æ–º.
*   **–ü—Ä–∏—á–∏–Ω–∞:** –°–µ—Ä–≤–∏—Å –∑–∞–≥—Ä—É–∂–∞–ª `jobs.json` –≤ –ø–∞–º—è—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ. –ò–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ –Ω–∞ –¥–∏—Å–∫–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å.
*   **–í–ª–∏—è–Ω–∏–µ:** –¢—Ä–µ–±–æ–≤–∞–ª—Å—è —Ä–µ—Å—Ç–∞—Ä—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏.

### 3. –ü—Ä–æ–±–ª–µ–º–∞ –ß–∞—Å–æ–≤—ã—Ö –ü–æ—è—Å–æ–≤ (Timezone Naivety)
*   **–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç –≤—ã–ø–æ–ª–Ω—è–ª –∑–∞–¥–∞—á–∏ –ø–æ UTC (–ì—Ä–∏–Ω–≤–∏—á—É), –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ª–æ–∫–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ú–°–ö).
*   **–ü—Ä–∏—á–∏–Ω–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `timezone` –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ –∏ —Å–µ—Ä–≤–∏—Å–µ. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `time.time()` (UTC) –±–µ–∑ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤.
*   **–í–ª–∏—è–Ω–∏–µ:** –ó–∞–¥–∞—á–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∏ —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º –≤ 3 —á–∞—Å–∞.

### 4. –ì–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–∏ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (Tool Hallucination)
*   **–°–∏–º–ø—Ç–æ–º:** –ë–æ—Ç "–¥—É–º–∞–ª", —á—Ç–æ —É–º–µ–µ—Ç —Å—Ç–∞–≤–∏—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è (`--at`), —Ö–æ—Ç—è –∫–æ–¥ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —ç—Ç–æ–≥–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–ª.
*   **–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `CronTool` –∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞/–∑–Ω–∞–Ω–∏–π –º–æ–¥–µ–ª–∏.

---

## üõ† –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –†–µ—à–µ–Ω–∏–µ

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: Heartbeat Loop
–ú—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–ª–∏ —Ü–∏–∫–ª —Ä–∞–±–æ—Ç—ã `CronService` ([service.py](nanobot/cron/service.py)):
*   **–í–º–µ—Å—Ç–æ —Å–Ω–∞:** –°–µ—Ä–≤–∏—Å —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ `_heartbeat_loop`.
*   **–ò–Ω—Ç–µ—Ä–≤–∞–ª:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∫–∞–∂–¥—ã–µ **60 —Å–µ–∫—É–Ω–¥** (—Å—Ç–∞–Ω–¥–∞—Ä—Ç cron).
*   **Hot Reload:** –í –∫–∞–∂–¥–æ–º —Ü–∏–∫–ª–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `mtime` (–≤—Ä–µ–º—è –∏–∑–º–µ–Ω–µ–Ω–∏—è) —Ñ–∞–π–ª–∞ `jobs.json`. –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –±–∞–∑–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ –ª–µ—Ç—É.

### –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Timezone
*   –í–Ω–µ–¥—Ä–µ–Ω–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `zoneinfo` –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Å–æ–≤—ã–º–∏ –ø–æ—è—Å–∞–º–∏.
*   –í `CronSchedule` –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `tz` (timezone).
*   –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –≤—Ä–µ–º–µ–Ω–∏ (`croniter`) —Ç–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å.

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏—è
–í `CronTool` ([cron.py](nanobot/agent/tools/cron.py)) –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
*   `at`: ISO 8601 timestamp –¥–ª—è —Ä–∞–∑–æ–≤—ã—Ö –∑–∞–¥–∞—á.
*   `timezone`: –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Europe/Moscow').

### –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
–°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç `tests/repro_cron.py`, –∫–æ—Ç–æ—Ä—ã–π:
1.  –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–µ—Ä–≤–∏—Å.
2.  –ò–º–∏—Ç–∏—Ä—É–µ—Ç –≤–Ω–µ—à–Ω–µ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –≤ —Ñ–∞–π–ª.
3.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–µ—Ä–≤–∏—Å –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –∑–∞–¥–∞—á—É –∏ –≤—ã–ø–æ–ª–Ω–∏–ª –µ—ë –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.

---

## üì¶ –°—Ç–∞—Ç—É—Å Git
–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –≤ –≤–µ—Ç–∫–µ `fix/cron-heartbeat-timezone`.
–ì–æ—Ç–æ–≤ Pull Request –¥–ª—è –≤–ª–∏–≤–∞–Ω–∏—è –≤ `main`.
